let MongoClient = require('mongodb').MongoClient;
let mongoose = require('mongoose');
let MongoUrl = "mongodb://localhost:27017/";


function queryRequest(req){   //查询数据时，根据请求返回查询数据所需的条件
  if(req._id) return {'request': {'_id' : mongoose.Types.ObjectId(req._id)}, 'start': 0, 'num': 0};   //如果是查询新插入的数据，start和num都为0，全局查找
  return req.email ? req.id ? {'request': {'email': req.email, 'id': req.id}, 'start': req.start, 'num': req.num} : {'request': {'email': req.email}, 'start': req.start, 'num': req.num} : '';
}


function queryData(req, res, collection){   //查询数据
  MongoClient.connect(MongoUrl, function(err, db) {
      if (err) throw err;
      var dbo = db.db("square");      //数据库
      let q = queryRequest(req)
      dbo.collection(collection).find(q.request).skip(parseInt(q.start)).limit(parseInt(q.num)).toArray(function(err, result) {
          if (err) throw err;
          res.setHeader("Access-Control-Allow-Origin", "*");      //允许跨域
          res.writeHead(200, {'Content-Type':'text/html; charset = UTF-8'});
          res.end(JSON.stringify({result}));
          db.close();
  });
  });
}


function insertData(req, res, collection){    //插入数据
  MongoClient.connect(MongoUrl, function(err, db) {
    if (err) throw err;
    var dbo = db.db("square");
    dbo.collection(collection).insertOne(req.obj, function(err, result) {
        if (err) throw err;
        console.log('插入成功');
        res.setHeader("Access-Control-Allow-Origin", "*");      //允许跨域
        res.writeHead(200, {'Content-Type':'text/html; charset = UTF-8'});
        res.end(JSON.stringify({result}));
        db.close();
    });
});
}


exports.queryData = queryData;
exports.insertData = insertData;