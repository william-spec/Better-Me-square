let fs = require('fs')
let {queryData, insertData} = require('./db');


function judgeResourceType(currentUrl){   //判断静态资源类型
  if(currentUrl.endsWith('.css'))
    return 'text/css';
  else if(currentUrl.endsWith('.js'))
    return 'text/javascript';
  /* 若请求的资源为字体文件，
    因为fontawesome中对字体文件的url后用?拼接了版本号用于更新缓存，
    然而node无法将url中的路径部分和用?拼接的参数部分区分开来，所以路径会出错，
    所以手动将font-awesome.min.css中url部分?后面的内容删去 */
  else if(currentUrl.endsWith('.woff2') || currentUrl.endsWith('.woff') )
    return 'application/x-font-woff';   
  else if(currentUrl.endsWith('.ttf'))
    return 'application/octet-stream';
  else if(currentUrl.endsWith('.jpg'))
    return 'image/jpg';
  else if(currentUrl.endsWith('.png'))
   return 'image/png';
}


function readHtml(req, res){    //读取html页面
  let currentUrl = req.url;
  let htmlName = 'square';    //默认为广场页
  if(currentUrl !== '/')
    htmlName = currentUrl.slice(currentUrl.indexOf('/')+1, currentUrl.indexOf('.'));
  fs.readFile('./view/square/' + htmlName + '.html', 'utf8', function(err, data){
    if (err) res.end(err);
    res.setHeader('Content-Type', 'text/html;charset=utf-8');
    res.end(data);
  })
}


function readSource(req, res){    //读取静态资源
  let currentUrl = req.url;
  let type = judgeResourceType(currentUrl);
  fs.readFile('.' + currentUrl, 'binary', function(err, data){    //这里使用utf8无法显示图片，使用binary正常，而文件的contenttype影响不大
    if (err) res.end(err);
    res.setHeader('Content-Type', type + ';charset=utf-8');
    res.write(data,'binary');
    res.end();
  })
}


function readDB(req, res){    //查询数据库数据
  let currentUrl = req.url;
  let collection = 'square';    //默认为广场页
  if(currentUrl === '/detailContent')
    collection = 'comments';
  //post
  let reqBody='';
  req.on('data',function (data) {
      reqBody += data;
  });
  // 在end事件触发后，通过querystring.parse将post解析为真正的POST请求格式，然后向客户端返回。
  req.on('end',function () {    //req完成后处理数据并返回
      reqBody = JSON.parse(reqBody);
      queryData(reqBody, res, collection);
    }
  )
}


function insertDB(req, res){
  let currentUrl = req.url;
  let collection = 'square';
  if(currentUrl.indexOf('DetailContent') !== -1)
    collection = 'comments';
  //post
  let reqBody='';
  req.on('data',function (data) {
      reqBody += data;
  });
  // 在end事件触发后，通过querystring.parse将post解析为真正的POST请求格式，然后向客户端返回。
  req.on('end',function () {    //req完成后处理数据并返回
      reqBody = JSON.parse(reqBody);
      //let id = '';
      insertData(reqBody, res, collection);      
    }
  )
}


function router(currentUrl, req, res){
  if (currentUrl === '/' || currentUrl.indexOf('html') !== -1) {    //请求页面
		readHtml(req, res);
	} 
  else if(currentUrl.startsWith('/public')){    //请求静态资源
    readSource(req, res);
  }
  else if(currentUrl === '/square' || currentUrl === '/userPost' || currentUrl === '/detailContent'){   //请求数据库数据
    readDB(req, res);
  }
  else if(currentUrl.indexOf('insert') !== -1){    //包含'insert'的请求，向数据库更新并获取新内容
    insertDB(req, res);
  }
}


exports.router = router;